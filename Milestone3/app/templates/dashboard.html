{% extends "base.html" %}

{% block title %}Dashboard - NovaQA{% endblock %}

{% block extra_css %}
<style>
    .dashboard-header {
        text-align: center;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }

    .dashboard-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, #06B6D4 0%, #8B5CF6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .dashboard-header p {
        color: #94A3B8;
        font-size: 1.1rem;
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .stat-box {
        background: rgba(30, 41, 59, 0.4);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid rgba(6, 182, 212, 0.2);
        text-align: center;
        transition: all 0.3s;
    }

    .stat-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(6, 182, 212, 0.2);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #06B6D4 0%, #8B5CF6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: #94A3B8;
        font-size: 0.95rem;
    }

    .main-card {
        background: rgba(30, 41, 59, 0.4);
        border-radius: 20px;
        padding: 3rem;
        border: 1px solid rgba(6, 182, 212, 0.2);
        margin-bottom: 2rem;
    }

    .card-title {
        color: #06B6D4;
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 2rem;
    }

    .input-methods {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .method-btn {
        background: rgba(15, 23, 42, 0.6);
        border: 2px solid rgba(6, 182, 212, 0.3);
        border-radius: 12px;
        padding: 1.5rem 1rem;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        color: #94A3B8;
    }

    .method-btn:hover {
        border-color: #06B6D4;
        background: rgba(6, 182, 212, 0.1);
        color: #06B6D4;
    }

    .method-btn.active {
        border-color: #06B6D4;
        background: rgba(6, 182, 212, 0.2);
        color: #06B6D4;
    }

    .method-btn i {
        font-size: 2rem;
        display: block;
        margin-bottom: 0.5rem;
    }

    .input-container {
        margin-bottom: 2rem;
    }

    .text-input {
        width: 100%;
        min-height: 150px;
        background: rgba(15, 23, 42, 0.6);
        border: 2px solid rgba(6, 182, 212, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        color: #E2E8F0;
        font-size: 1rem;
        font-family: 'Inter', sans-serif;
        resize: vertical;
        transition: all 0.3s;
    }

    .text-input:focus {
        outline: none;
        border-color: #06B6D4;
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }

    .file-upload-area {
        border: 2px dashed rgba(6, 182, 212, 0.3);
        border-radius: 12px;
        padding: 3rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }

    .file-upload-area:hover {
        border-color: #06B6D4;
        background: rgba(6, 182, 212, 0.05);
    }

    .file-upload-area i {
        font-size: 3rem;
        color: #06B6D4;
        margin-bottom: 1rem;
    }

    .options-group {
        display: flex;
        gap: 2rem;
        align-items: center;
        margin: 1.5rem 0;
        flex-wrap: wrap;
    }

    .option-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #CBD5E1;
    }

    .option-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }

    .execution-card {
        background: rgba(15, 23, 42, 0.6);
        border-radius: 12px;
        padding: 2rem;
        border: 1px solid rgba(6, 182, 212, 0.2);
        margin-top: 2rem;
        display: none;
    }

    .execution-card.show {
        display: block;
    }

    .result-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(6, 182, 212, 0.2);
    }

    .timeline-item {
        background: rgba(30, 41, 59, 0.4);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-left: 4px solid #06B6D4;
    }

    .timeline-item.failed {
        border-left-color: #EF4444;
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .timeline-action {
        color: #E2E8F0;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .timeline-status {
        padding: 0.25rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .timeline-status.passed {
        background: rgba(16, 185, 129, 0.2);
        color: #10B981;
    }

    .timeline-status.failed {
        background: rgba(239, 68, 68, 0.2);
        color: #EF4444;
    }

    .timeline-description {
        color: #94A3B8;
        margin-bottom: 0.5rem;
    }

    .timeline-time {
        color: #64748B;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<section class="dashboard-header">
    <h1>NovaQA Dashboard</h1>
    <p>Create and execute automated tests with AI</p>
</section>

<!-- Statistics Row -->
<div class="stats-row">
    <div class="stat-box">
        <div class="stat-number" id="totalTests">0</div>
        <div class="stat-label">Total Tests</div>
    </div>
    <div class="stat-box">
        <div class="stat-number" id="passedTests">0</div>
        <div class="stat-label">Passed</div>
    </div>
    <div class="stat-box">
        <div class="stat-number" id="failedTests">0</div>
        <div class="stat-label">Failed</div>
    </div>
    <div class="stat-box">
        <div class="stat-number" id="successRate">0%</div>
        <div class="stat-label">Success Rate</div>
    </div>
</div>

<!-- Main Test Creation Card -->
<div class="main-card">
    <h2 class="card-title">
        <i class="fas fa-plus-circle"></i> Create New Test
    </h2>

    <!-- Input Method Selection -->
    <div class="input-methods">
        <div class="method-btn active" onclick="selectMethod('text')" id="method-text">
            <i class="fas fa-keyboard"></i>
            <div>Text Input</div>
        </div>
        <div class="method-btn" onclick="selectMethod('file')" id="method-file">
            <i class="fas fa-file-upload"></i>
            <div>Upload File</div>
        </div>
        <div class="method-btn" onclick="selectMethod('url')" id="method-url">
            <i class="fas fa-link"></i>
            <div>Form URL</div>
        </div>
        <div class="method-btn" onclick="selectMethod('image')" id="method-image">
            <i class="fas fa-image"></i>
            <div>Screenshot</div>
        </div>
    </div>

    <form id="testForm">
        <!-- Text Input (Default) -->
        <div id="input-text" class="input-container">
            <textarea 
                id="instructionText" 
                class="text-input" 
                placeholder="Enter test instruction in plain English...

Example: open google.com and search artificial intelligence"
            ></textarea>
        </div>

        <!-- File Upload -->
        <div id="input-file" class="input-container" style="display: none;">
            <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <p style="color: #CBD5E1; margin-bottom: 0.5rem;">Click to upload test file</p>
                <p style="color: #64748B; font-size: 0.9rem;">Supports: .txt, .doc, .pdf</p>
                <input type="file" id="fileInput" accept=".txt,.doc,.docx,.pdf" style="display: none;">
            </div>
            <p id="fileName" style="color: #06B6D4; margin-top: 1rem; text-align: center;"></p>
        </div>

        <!-- URL Input -->
        <div id="input-url" class="input-container" style="display: none;">
            <input 
                type="url" 
                id="urlInput" 
                class="text-input" 
                style="min-height: auto;" 
                placeholder="Enter form URL to test...

Example: https://example.com/contact-form"
            >
        </div>

        <!-- Image Upload -->
        <div id="input-image" class="input-container" style="display: none;">
            <div class="file-upload-area" onclick="document.getElementById('imageInput').click()">
                <i class="fas fa-image"></i>
                <p style="color: #CBD5E1; margin-bottom: 0.5rem;">Upload screenshot for OCR</p>
                <p style="color: #64748B; font-size: 0.9rem;">Supports: .jpg, .png</p>
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
            </div>
            <p id="imageName" style="color: #06B6D4; margin-top: 1rem; text-align: center;"></p>
        </div>

        <!-- Options -->
        <div class="options-group">
            <label class="option-item">
                <input type="checkbox" id="headlessMode" checked>
                <span>Headless Mode (faster)</span>
            </label>
            <label class="option-item">
                <input type="checkbox" id="autoValidation" checked>
                <span>Auto Validation</span>
            </label>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-play-circle"></i> Run Test
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                <i class="fas fa-redo"></i> Reset
            </button>
        </div>
    </form>
</div>

<!-- Execution Timeline -->
<div id="executionCard" class="execution-card">
    <h3 style="color: #06B6D4; margin-bottom: 1.5rem;">
        <i class="fas fa-tasks"></i> Execution Timeline
    </h3>
    <div id="timelineContainer"></div>

    <!-- Action Buttons After Test -->
    <div class="result-actions">
        <button class="btn btn-secondary" onclick="downloadCurrentReport('html')">
            <i class="fas fa-download"></i> Download HTML Report
        </button>
        <button class="btn btn-primary" onclick="downloadCurrentReport('pdf')">
            <i class="fas fa-file-pdf"></i> Download PDF Report
        </button>
        <a href="/reports" class="btn btn-primary" style="background: linear-gradient(135deg, #8B5CF6 0%, #06B6D4 100%);">
            <i class="fas fa-history"></i> View All Reports
        </a>
    </div>
</div>

<script>
let currentMethod = 'text';
let testCount = 0;
let passedCount = 0;
let failedCount = 0;
let currentReportId = null; // Store current report ID

function selectMethod(method) {
    // Update active button
    document.querySelectorAll('.method-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById('method-' + method).classList.add('active');

    // Show/hide input containers
    document.querySelectorAll('.input-container').forEach(container => {
        container.style.display = 'none';
    });
    document.getElementById('input-' + method).style.display = 'block';

    currentMethod = method;
}

function resetForm() {
    document.getElementById('testForm').reset();
    document.getElementById('fileName').textContent = '';
    document.getElementById('imageName').textContent = '';
    document.getElementById('executionCard').classList.remove('show');
    currentReportId = null;
}

// File upload handlers
document.getElementById('fileInput').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        document.getElementById('fileName').textContent = 'Selected: ' + e.target.files[0].name;
    }
});

document.getElementById('imageInput').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        document.getElementById('imageName').textContent = 'Selected: ' + e.target.files[0].name;
    }
});

// Form submission
document.getElementById('testForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    let instruction = '';
    
    if (currentMethod === 'text') {
        instruction = document.getElementById('instructionText').value.trim();
    } else if (currentMethod === 'url') {
        instruction = 'open ' + document.getElementById('urlInput').value.trim();
    } else {
        alert('File and image upload coming soon!');
        return;
    }

    if (!instruction) {
        alert('Please provide test instruction');
        return;
    }

    const headless = document.getElementById('headlessMode').checked;

    // Show execution card with loading
    document.getElementById('executionCard').classList.add('show');
    document.getElementById('timelineContainer').innerHTML = `
        <div style="text-align: center; padding: 2rem;">
            <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #06B6D4;"></i>
            <p style="color: #94A3B8; margin-top: 1rem;">Executing test...</p>
        </div>
    `;

    try {
        const response = await fetch('/api/run-test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                instruction: instruction,
                headless: headless
            })
        });

        const data = await response.json();

        if (data.success) {
            currentReportId = data.report_id; // STORE REPORT ID
            displayExecution(data.execution || []);
            updateStats(data.execution || []);
        } else {
            document.getElementById('timelineContainer').innerHTML = `
                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 2rem; color: #EF4444;">
                    <strong>Error:</strong> ${data.error}
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('timelineContainer').innerHTML = `
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 2rem; color: #EF4444;">
                <strong>Connection Error:</strong> ${error.message}
            </div>
        `;
    }
});

function displayExecution(steps) {
    const container = document.getElementById('timelineContainer');
    container.innerHTML = '';

    steps.forEach((step, index) => {
        const item = document.createElement('div');
        item.className = 'timeline-item' + (step.status === 'Failed' ? ' failed' : '');
        item.innerHTML = `
            <div class="timeline-header">
                <div class="timeline-action">Step ${index + 1}: ${step.action || 'Unknown'}</div>
                <div class="timeline-status ${step.status.toLowerCase()}">${step.status}</div>
            </div>
            <div class="timeline-description">${step.description || step.details || 'No description'}</div>
            <div class="timeline-time">Executed just now</div>
        `;
        container.appendChild(item);
    });
}

function updateStats(steps) {
    testCount++;
    const passed = steps.filter(s => s.status === 'Passed').length;
    const failed = steps.filter(s => s.status === 'Failed').length;

    if (failed === 0) {
        passedCount++;
    } else {
        failedCount++;
    }

    document.getElementById('totalTests').textContent = testCount;
    document.getElementById('passedTests').textContent = passedCount;
    document.getElementById('failedTests').textContent = failedCount;
    
    const rate = testCount > 0 ? Math.round((passedCount / testCount) * 100) : 0;
    document.getElementById('successRate').textContent = rate + '%';
}

// Download current report
async function downloadCurrentReport(format) {
    if (!currentReportId) {
        alert('No test data available. Please run a test first.');
        return;
    }

    try {
        const response = await fetch(`/api/download-report/${format}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ report_id: currentReportId })
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentReportId}.${format}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            alert('Failed to download report');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
{% endblock %}